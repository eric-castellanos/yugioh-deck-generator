name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'destroy' to confirm"
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  terraform-destroy:
    if: ${{ github.event.inputs.confirm == 'destroy' }}
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: dev
      AWS_REGION: us-east-1
      TF_IN_AUTOMATION: true

    defaults:
      run:
        working-directory: infra/terraform

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Destroy (initial attempt)
        id: destroy
        continue-on-error: true
        shell: bash
        run: |
          set +e
          set -o pipefail
          RAW_LOG="raw_destroy_output.txt"

          terraform destroy -auto-approve \
            -var "db_password=${{ secrets.MLFLOW_DB_PASSWORD }}" \
            -var "account_id=${{ secrets.AWS_ACCOUNT_ID }}" \
            -var "cluster_name=mlflow-cluster-${{ env.ENVIRONMENT }}" \
            > $RAW_LOG 2>&1
          
          #-target=module.eks \
          #-target=module.mlflow \

          DESTROY_EXIT_CODE=$?

          # Extract lock ID
          LOCK_ID=$(grep -Eo 'ID:[[:space:]]+[a-f0-9-]+' "$RAW_LOG" | awk '{print $2}')

          if [[ -n "$LOCK_ID" ]]; then
            echo "Terraform state lock detected: $LOCK_ID"
            echo "lock_id=$LOCK_ID" >> $GITHUB_OUTPUT
          else
            echo "lock_id=" >> $GITHUB_OUTPUT
          fi

          # Export success status
          if [[ $DESTROY_EXIT_CODE -eq 0 ]]; then
            echo "destroy_success=true" >> $GITHUB_OUTPUT
          else
            echo "destroy_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Force Unlock (if needed)
        if: ${{ steps.destroy.outputs.lock_id != '' }}
        run: terraform force-unlock -force ${{ steps.destroy.outputs.lock_id }}

      - name: Terraform Destroy (retry after unlock)
        if: ${{ steps.destroy.outputs.destroy_success == 'false' }}
        run: |
          terraform destroy -input=false -auto-approve \
            -var "db_password=${{ secrets.MLFLOW_DB_PASSWORD }}" \
            -var "account_id=${{ secrets.AWS_ACCOUNT_ID }}" \
            -var "cluster_name=mlflow-cluster-${{ env.ENVIRONMENT }}" \
            # -target=module.eks \
            # -target=module.mlflow

      - name: Upload Destroy Log
        uses: actions/upload-artifact@v4
        with:
          name: destroy-log
          path: infra/terraform/raw_destroy_output.txt


